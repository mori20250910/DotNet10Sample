@page
@model DetailModel
@{
    ViewData["Title"] = "品目詳細";
}

<h1 class="mb-4">品目詳細</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

@if (Model.Item != null)
{
    <div class="card">
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">ID</dt>
                <dd class="col-sm-9">@Model.Item.Id</dd>
            </dl>

            <form id="updateForm" method="post" asp-page-handler="Update" novalidate>
                @Html.AntiForgeryToken()
                <input asp-for="Id" type="hidden" />

                <div class="mb-3">
                    <label class="form-label">品目コード</label>
                    <input asp-for="ItemCode" id="itemCodeInput" class="form-control" readonly maxlength="5" data-original="@Model.Item?.Code" />
                    <span asp-validation-for="ItemCode" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label">品目名</label>
                    <input asp-for="ItemName" id="itemNameInput" class="form-control" readonly maxlength="10" data-original="@Model.Item?.Name" />
                    <span asp-validation-for="ItemName" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label">品目カテゴリ</label>
                    <select asp-for="CategoryCode" id="categorySelect" class="form-select" disabled data-original="@Model.Item?.CategoryCode">
                        <option value="">-- 未選択 --</option>
                        @foreach (var c in Model.Categories)
                        {
                            <option value="@c.Code">@c.Code - @c.Name</option>
                        }
                    </select>
                    <span asp-validation-for="CategoryCode" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label">備考</label>
                    <textarea asp-for="Remarks" id="remarksInput" class="form-control" readonly maxlength="100" data-original="@Model.Item?.Remarks"></textarea>
                    <span asp-validation-for="Remarks" class="text-danger"></span>
                </div>

                <span id="validationMessage" class="text-danger"></span>
            </form>

            <div id="ajaxMessage" class="mt-2"></div>

            <div class="d-flex justify-content-between mt-3">
                <div>
                    <button type="button" id="editToggle" class="btn btn-outline-primary">更新モード</button>
                    <button type="button" id="updateButton" class="btn btn-primary ms-2" disabled>更新</button>
                </div>
                <div>
                    <a asp-page="/Search" class="btn btn-secondary">検索画面に戻る</a>
                </div>
            </div>

            <script>
                (function() {
                    const editBtn = document.getElementById('editToggle');
                    const input = document.getElementById('itemNameInput');
                    const updateBtn = document.getElementById('updateButton');
                    const form = document.getElementById('updateForm');
                    const ajaxMessage = document.getElementById('ajaxMessage');
                    const validationMessage = document.getElementById('validationMessage');
                    const codeInput = document.getElementById('itemCodeInput');
                    const categorySelect = document.getElementById('categorySelect');
                    const remarksInput = document.getElementById('remarksInput');
                    // initialize originals from dataset attributes (stable DOM values) or current values as fallback
                    let original = {
                        code: (codeInput && codeInput.dataset && codeInput.dataset.original) ? codeInput.dataset.original : (codeInput ? codeInput.value : ''),
                        name: (input && input.dataset && input.dataset.original) ? input.dataset.original : (input ? input.value : ''),
                        category: (categorySelect && categorySelect.dataset && categorySelect.dataset.original) ? categorySelect.dataset.original : (categorySelect ? categorySelect.value : ''),
                        remarks: (remarksInput && remarksInput.dataset && remarksInput.dataset.original) ? remarksInput.dataset.original : (remarksInput ? remarksInput.value : '')
                    };

                    function showMessage(html, isSuccess) {
                        ajaxMessage.innerHTML = html;
                        ajaxMessage.className = isSuccess ? 'alert alert-success mt-2' : 'alert alert-danger mt-2';
                    }

                    editBtn.addEventListener('click', function() {
                        const isReadOnly = input.hasAttribute('readonly');
                        if (isReadOnly) {
                            input.removeAttribute('readonly');
                            categorySelect.removeAttribute('disabled');
                            remarksInput.removeAttribute('readonly');
                            input.focus();
                            updateBtn.disabled = false;
                            editBtn.textContent = '編集をキャンセル';
                        } else {
                            input.setAttribute('readonly', 'readonly');
                            codeInput.setAttribute('readonly', 'readonly');
                            categorySelect.setAttribute('disabled', 'disabled');
                            remarksInput.setAttribute('readonly', 'readonly');
                            updateBtn.disabled = true;
                            editBtn.textContent = '更新モード';
                            // restore from dataset originals (stable server values) with JS original as fallback
                            input.value = (input && input.dataset && input.dataset.original) ? input.dataset.original : original.name;
                            codeInput.value = (codeInput && codeInput.dataset && codeInput.dataset.original) ? codeInput.dataset.original : original.code;
                            categorySelect.value = (categorySelect && categorySelect.dataset && categorySelect.dataset.original) ? categorySelect.dataset.original : original.category;
                            remarksInput.value = (remarksInput && remarksInput.dataset && remarksInput.dataset.original) ? remarksInput.dataset.original : original.remarks;
                            validationMessage.textContent = '';
                            ajaxMessage.textContent = '';
                        }
                    });

                    // When the external Update button is clicked, submit the form.
                    updateBtn.addEventListener('click', function() {
                        if (typeof form.requestSubmit === 'function') {
                            form.requestSubmit();
                        } else {
                            // fallback for older browsers
                            form.dispatchEvent(new Event('submit', { cancelable: true }));
                        }
                    });

                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        validationMessage.textContent = '';
                        ajaxMessage.textContent = '';

                        const formData = new FormData(form);
                        const body = new URLSearchParams();
                        for (const pair of formData.entries()) {
                            body.append(pair[0], pair[1]);
                        }

                        try {
                            const res = await fetch(window.location.pathname + '?handler=Update', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: body
                            });

                            if (res.ok) {
                                const data = await res.json();
                                if (data?.success) {
                                    original = {
                                        code: data.code || formData.get('ItemCode'),
                                        name: data.name || formData.get('ItemName'),
                                        category: data.category || formData.get('CategoryCode'),
                                        remarks: data.remarks || formData.get('Remarks')
                                    };
                                    // update DOM dataset originals so cancel always restores server-canonical values
                                    codeInput.dataset.original = original.code || '';
                                    input.dataset.original = original.name || '';
                                    categorySelect.dataset.original = original.category || '';
                                    remarksInput.dataset.original = original.remarks || '';

                                    input.setAttribute('readonly', 'readonly');
                                    codeInput.setAttribute('readonly', 'readonly');
                                    categorySelect.setAttribute('disabled', 'disabled');
                                    remarksInput.setAttribute('readonly', 'readonly');
                                    updateBtn.disabled = true;
                                    editBtn.textContent = '更新モード';
                                    showMessage(data.message || '更新しました。', true);
                                } else {
                                    showMessage('更新に失敗しました。', false);
                                }
                            } else if (res.status === 400) {
                                const data = await res.json();
                                const errors = data?.errors || ['入力に誤りがあります。'];
                                validationMessage.textContent = errors.join(' ');
                            } else {
                                const data = await res.json().catch(() => null);
                                const msg = data?.errors?.[0] || 'サーバーエラーが発生しました。';
                                showMessage(msg, false);
                            }
                        } catch (err) {
                            showMessage('通信エラーが発生しました。', false);
                        }
                    });
                })();
            </script>
        </div>
    </div>
}

