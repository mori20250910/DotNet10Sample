@page
@model ManufacturingModel
@{
    ViewData["Title"] = "製造計画";
}

<h1 class="mb-4">製造計画</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<div class="row mb-3">
    <div class="col-auto">
        <form method="get" class="d-flex align-items-end gap-2">
            <div>
                <label class="form-label">月選択</label>
                <input type="month" id="yearMonth" name="YearMonth" class="form-control" value="@Model.YearMonth" />
            </div>
            <div class="d-flex gap-2">
                <button type="button" id="prevMonthBtn" class="btn btn-outline-secondary">◀ 前月</button>
                <button type="button" id="nextMonthBtn" class="btn btn-outline-secondary">次月 ▶</button>
            </div>
            <button type="submit" class="btn btn-primary">表示</button>
        </form>
    </div>
</div>

<div class="mb-2">
    <p class="text-muted">
        表示期間：<strong>@Model.StartDate?.ToString("yyyy年M月d日")</strong> ～ <strong>@Model.EndDate?.ToString("M月d日")</strong>
    </p>
</div>

<form id="planForm" method="post" asp-page-handler="Save" novalidate>
    <input type="hidden" id="yearMonthHidden" name="YearMonth" value="@Model.YearMonth" />
    <div class="table-responsive">
        <table class="table table-bordered table-sm" style="table-layout: fixed;">
            <colgroup>
                <col style="width: 188px;">
            </colgroup>
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="width: 188px; position: sticky; left: 0; background-color: #f8f9fa; min-width: 188px; padding: 8px;">品目</th>
                    @foreach (var date in Model.PlanDates)
                    {
                        var isHoliday = Model.Holidays.Contains(date.Date);
                        var isJapaneseHoliday = Model.JapaneseHolidays.Contains(date.Date);
                        var note = Model.HolidayLabels.ContainsKey(date.Date) ? Model.HolidayLabels[date.Date] : null;
                        <th style="text-align: center; min-width: 80px; @(isHoliday ? "background-color: #ffcccb;" : "")" data-holiday-note="@(note ?? "")" title="@(note ?? "")" class="@(note != null ? "has-note" : "")">
                            @date.ToString("M/d")<br />
                            <small class="text-muted">(@date.ToString("ddd"))</small>
                            @if (isJapaneseHoliday)
                            {
                                <br /><span class="badge bg-danger">祝</span>
                            }
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td style="width: 188px; min-width: 188px; position: sticky; left: 0; background-color: #f8f9fa; padding: 8px; overflow-wrap: break-word;">
                            <strong>@item.Name</strong>
                            @if (Model.ItemManufactureStartDates.ContainsKey(item.Id) && Model.ItemManufactureStartDates[item.Id].HasValue)
                            {
                                <div class="small text-muted">製造開始: @(Model.ItemManufactureStartDates[item.Id]?.ToString("yyyy/M/d"))</div>
                            }
                        </td>
                        @foreach (var date in Model.PlanDates)
                        {
                            var quantity = Model.PlanData.ContainsKey((item.Id, date)) ? Model.PlanData[(item.Id, date)] : 0;
                            var isBeforeManufactureStart = Model.ItemManufactureStartDates.ContainsKey(item.Id) && 
                                                           Model.ItemManufactureStartDates[item.Id].HasValue && 
                                                           date < Model.ItemManufactureStartDates[item.Id].GetValueOrDefault();
                            var isHoliday = Model.Holidays.Contains(date.Date);
                            var note = Model.HolidayLabels.ContainsKey(date.Date) ? Model.HolidayLabels[date.Date] : null;
                            <td style="text-align: center; @(isHoliday ? "background-color: #ffcccb;" : "")" data-holiday-note="@(note ?? "")" title="@(note ?? "")" class="@(note != null ? "has-note" : "")">
                                <input 
                                    type="text" 
                                    name="qty_@(item.Id)_@(date.ToString("yyyy-MM-dd"))" 
                                    class="form-control form-control-sm qty-input" 
                                    value="@(quantity > 0 ? quantity.ToString() : "")" 
                                    placeholder="-"
                                    style="text-align: center; padding: 6px 4px;"
                                    data-item-id="@item.Id"
                                    data-plan-date="@date.ToString("yyyy-MM-dd")"
                                    @(isBeforeManufactureStart || isHoliday ? "disabled" : "")
                                    />
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div id="validationMessage" class="text-danger mt-2 mb-3"></div>

    <div class="d-flex justify-content-end gap-2">
        <button type="button" id="exportCsvBtn" class="btn btn-outline-secondary">CSV出力</button>
        <button type="button" id="exportPdfBtn" class="btn btn-outline-secondary">PDF出力</button>
        <button type="button" id="saveBtn" class="btn btn-primary">保存</button>
        <a asp-page="/Index" class="btn btn-secondary">メニューに戻る</a>
    </div>       
</form>

@section Scripts {
    <script>
        (function() {
            const yearMonthInput = document.getElementById('yearMonth');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const saveBtn = document.getElementById('saveBtn');
            const planForm = document.getElementById('planForm');
            const validationMessage = document.getElementById('validationMessage');

            // Previous month button handler
            prevMonthBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (!yearMonthInput.value) return;
                
                const [year, month] = yearMonthInput.value.split('-').map(Number);
                let newMonth = month - 1;
                let newYear = year;
                
                if (newMonth < 1) {
                    newMonth = 12;
                    newYear--;
                }
                
                yearMonthInput.value = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                yearMonthInput.form.submit();
            });

            // Next month button handler
            nextMonthBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (!yearMonthInput.value) return;
                
                const [year, month] = yearMonthInput.value.split('-').map(Number);
                let newMonth = month + 1;
                let newYear = year;
                
                if (newMonth > 12) {
                    newMonth = 1;
                    newYear++;
                }
                
                yearMonthInput.value = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                yearMonthInput.form.submit();
            });

            // Save button handler
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                validationMessage.textContent = '';

                // Validate quantity inputs
                const qtyInputs = document.querySelectorAll('.qty-input');
                let hasErrors = false;
                let errorMessages = [];

                qtyInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value === '') {
                        // Empty is allowed, skip validation
                        return;
                    }

                    const quantity = parseInt(value, 10);
                    if (isNaN(quantity) || quantity < 1 || quantity > 99) {
                        hasErrors = true;
                        const itemId = input.dataset.itemId;
                        const planDate = input.dataset.planDate;
                        errorMessages.push(`品目ID ${itemId} の ${new Date(planDate).toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' })} は1～99の数字のみ入力可能です。`);
                    }
                });

                if (hasErrors) {
                    validationMessage.textContent = errorMessages.join(' ');
                    return;
                }

                // Submit form
                const formData = new FormData(planForm);
                // Ensure YearMonth is set in the hidden field
                const yearMonthField = document.getElementById('yearMonthHidden');
                formData.set('YearMonth', yearMonthInput.value);

                const body = new URLSearchParams();
                for (const pair of formData.entries()) {
                    body.append(pair[0], pair[1]);
                }

                fetch(window.location.pathname + '?handler=Save', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: body
                })
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    } else if (res.status === 400) {
                        return res.json().then(data => {
                            throw data;
                        });
                    } else {
                        throw new Error('Server error');
                    }
                })
                .then(data => {
                    if (data.success) {
                        // 表示をダイアログではなく、タブのタイトルで通知する（一定時間表示してからリロード）
                        const _prevTitle = document.title;
                        document.title = '製造計画を保存しました。';
                        setTimeout(() => {
                            document.title = _prevTitle;
                            location.reload();
                        }, 1200);
                    } else {
                        validationMessage.innerHTML = '<strong>保存に失敗しました:</strong><br />' + (data.errors || []).join('<br />');
                    }
                })
                .catch(err => {
                    if (err.errors) {
                        validationMessage.innerHTML = '<strong>エラーが発生しました:</strong><br />' + err.errors.join('<br />');
                    } else {
                        validationMessage.textContent = '通信エラーが発生しました。';
                    }
                });
            });

            // Format input to allow only 1-99
            document.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('blur', function() {
                    const value = this.value.trim();
                    if (value === '') {
                        return;
                    }
                    const quantity = parseInt(value, 10);
                    if (isNaN(quantity) || quantity < 1 || quantity > 99) {
                        // Invalid, clear it
                        this.value = '';
                    } else {
                        // Valid, format without leading zeros
                        this.value = quantity.toString();
                    }
                });

                // Prevent non-numeric input
                input.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key)) {
                        e.preventDefault();
                    }
                });
            });

            // コメント表示: ポップアップは行わない（何もしない）

            // CSV出力ボタンハンドラ（クライアントでテーブルをCSVに変換してダウンロード）
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    const table = document.querySelector('.table');
                    if (!table) {
                        alert('テーブルが見つかりません。');
                        return;
                    }

                    const escapeCsv = (s) => '"' + String(s ?? '').replace(/"/g, '""') + '"';

                    // ヘッダ取得（1列目は品目）
                    const headerCells = Array.from(table.querySelectorAll('thead th'));
                    const headers = ['品目'];
                    for (let i = 1; i < headerCells.length; i++) {
                        const th = headerCells[i];
                        // 表示用テキスト（改行をスペースに）
                        const txt = th.textContent.replace(/\s+/g, ' ').trim();
                        const note = th.getAttribute('data-holiday-note');
                        headers.push(note ? `${txt} (${note})` : txt);
                    }

                    const rows = [headers.map(escapeCsv).join(',')];

                    // 各行を処理
                    const bodyRows = Array.from(table.querySelectorAll('tbody tr'));
                    bodyRows.forEach(tr => {
                        const tds = Array.from(tr.querySelectorAll('td'));
                        const name = tds[0] ? tds[0].textContent.replace(/\s+/g, ' ').trim() : '';
                        const values = [];
                        for (let i = 1; i < tds.length; i++) {
                            const input = tds[i].querySelector('input');
                            const val = input ? input.value.trim() : '';
                            values.push(val);
                        }
                        rows.push([escapeCsv(name), ...values.map(escapeCsv)].join(','));
                    });

                    const csvContent = '\uFEFF' + rows.join('\n'); // BOM付き
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const ym = document.getElementById('yearMonth') ? document.getElementById('yearMonth').value : '';
                    const filename = ym ? `manufacturing_${ym}.csv` : 'manufacturing.csv';
                    a.href = url;
                    a.setAttribute('download', filename);
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                });
            }

            // PDF出力ボタンハンドラ
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    const yearMonthField = document.getElementById('yearMonthHidden');
                    const ym = document.getElementById('yearMonth') ? document.getElementById('yearMonth').value : '';
                    
                    if (!ym) {
                        alert('月が指定されていません。');
                        return;
                    }

                    // フォームデータを構築
                    const formData = new FormData(planForm);
                    formData.set('YearMonth', ym);

                    const body = new URLSearchParams();
                    for (const pair of formData.entries()) {
                        body.append(pair[0], pair[1]);
                    }

                    // POST リクエストで PDF を取得
                    fetch(window.location.pathname + '?handler=ExportPdf', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: body
                    })
                    .then(res => {
                        if (res.ok) {
                            return res.blob().then(blob => ({ ok: true, blob: blob }));
                        } else {
                            // エラーレスポンスをJSON として解析
                            return res.json().then(data => {
                                return { ok: false, error: data.message || 'PDF生成に失敗しました。' };
                            });
                        }
                    })
                    .then(result => {
                        if (result.ok) {
                            const url = URL.createObjectURL(result.blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.setAttribute('download', `manufacturing_${ym}.pdf`);
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            URL.revokeObjectURL(url);
                        } else {
                            throw new Error(result.error);
                        }
                    })
                    .catch(err => {
                        alert(err.message || 'PDF出力に失敗しました。');
                    });
                });
            }
        })();
    </script>

    <style>
        .table {
            margin-bottom: 0;
        }

        .table-responsive {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }

        .qty-input {
            font-weight: bold;
        }

        .qty-input:disabled {
            background-color: #e9ecef;
            cursor: default;
        }

        thead th {
            vertical-align: middle;
        }

        /* Indicates an element has a holiday/comment note (shows native tooltip on hover) */
        .has-note {
            cursor: default;
        }
    </style>
}
